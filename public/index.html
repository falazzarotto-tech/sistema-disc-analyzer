<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ânima - Análise</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-50">
    <div class="max-w-md mx-auto bg-white rounded-3xl p-8 shadow-sm border mt-10">
        <div class="text-center mb-8">
            <img src="/logo-anima.png" class="w-40 mx-auto mb-4">
            <h2 id="stepTitle" class="text-gray-500 text-sm uppercase font-bold">Cadastro</h2>
        </div>

        <form id="userForm" class="space-y-4">
            <input type="text" id="name" required placeholder="NOME" class="w-full border-b p-2 outline-none">
            <input type="email" id="email" required placeholder="E-MAIL" class="w-full border-b p-2 outline-none">
            <select id="context" class="w-full border-b p-2 outline-none bg-white">
                <option value="Autoconhecimento">AUTOCONHECIMENTO</option>
                <option value="Desenvolvimento">DESENVOLVIMENTO</option>
            </select>
            <button type="submit" class="w-full bg-black text-white py-4 rounded-xl font-bold">COMEÇAR</button>
        </form>

        <div id="questionBox" class="hidden space-y-6">
            <p id="questionText" class="text-center font-bold text-lg"></p>
            <div class="flex justify-between gap-2">
                <button class="btn-score border p-4 w-full rounded-xl font-bold" data-score="1">1</button>
                <button class="btn-score border p-4 w-full rounded-xl font-bold" data-score="2">2</button>
                <button class="btn-score border p-4 w-full rounded-xl font-bold" data-score="3">3</button>
                <button class="btn-score border p-4 w-full rounded-xl font-bold" data-score="4">4</button>
                <button class="btn-score border p-4 w-full rounded-xl font-bold" data-score="5">5</button>
            </div>
        </div>

        <div id="finalBox" class="hidden text-center space-y-4">
            <h2 class="text-xl font-bold">Concluído!</h2>
            <button id="downloadBtn" class="w-full bg-[#F85E5E] text-white py-4 rounded-xl font-bold">BAIXAR RELATÓRIO</button>
        </div>
    </div>

    <script>
        let userId = '';
        let currentIdx = 0;
        let answers = [];
        const questions = [
            { id: 1, text: "Sinto facilidade em expressar ideias.", dim: "Expressão" },
            { id: 2, text: "Tomo decisões rápidas.", dim: "Decisão" },
            { id: 3, text: "Sigo regras e processos.", dim: "Regulação" },
            { id: 4, text: "Analiso o contexto antes.", dim: "Contexto" }
        ];

        document.getElementById('userForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await fetch('/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: document.getElementById('name').value.toUpperCase(),
                    email: document.getElementById('email').value.toLowerCase(),
                    context: document.getElementById('context').value
                })
            });
            const user = await res.json();
            userId = user.id;
            document.getElementById('userForm').classList.add('hidden');
            document.getElementById('questionBox').classList.remove('hidden');
            document.getElementById('stepTitle').innerText = "Avaliação";
            showQ();
        };

        function showQ() {
            document.getElementById('questionText').innerText = questions[currentIdx].text;
        }

        document.querySelectorAll('.btn-score').forEach(btn => {
            btn.onclick = async () => {
                answers.push({
                    questionId: questions[currentIdx].id,
                    dimension: questions[currentIdx].dim,
                    score: parseInt(btn.dataset.score)
                });
                currentIdx++;
                if(currentIdx < questions.length) {
                    showQ();
                } else {
                    await save();
                }
            };
        });

        async function save() {
            await fetch('/disc/answers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId, answers })
            });
            document.getElementById('questionBox').classList.add('hidden');
            document.getElementById('finalBox').classList.remove('hidden');
        }

        document.getElementById('downloadBtn').onclick = () => {
            window.location.href = `/disc/${userId}/pdf`;
        };
    </script>
</body>
</html>
